#!/usr/bin/env python
# -*- coding: utf-8 -*-
### BEGIN LICENSE
# Copyright (C) 2009 Didier Roche <didrocks@ubuntu.com>
#This program is free software: you can redistribute it and/or modify it 
#under the terms of the GNU General Public License version 3, as published 
#by the Free Software Foundation.
#
#This program is distributed in the hope that it will be useful, but 
#WITHOUT ANY WARRANTY; without even the implied warranties of 
#MERCHANTABILITY, SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR 
#PURPOSE.  See the GNU General Public License for more details.
#
#You should have received a copy of the GNU General Public License along 
#with this program.  If not, see <http://www.gnu.org/licenses/>.
### END LICENSE

import logging
from optparse import OptionParser
import os
import time
import sys

# Check if we are working in the source tree or from an installed 
# vers_Ã§h and mangle the python path accordingly
parent_module_path  = os.path.abspath(os.path.dirname(sys.argv[0]) + '/..')
sys.path.insert(0, parent_module_path)

from notifythis import checknotif
from notifythis.daemon import Daemon

LEVELS = (  logging.ERROR,
            logging.WARNING,
            logging.INFO,
            logging.DEBUG,
            )

class MyDaemon(Daemon):
    
    def __init__(self, config_file, pidfile):
        Daemon.__init__(self, pidfile, stdout='/tmp/log', stderr='/tmp/logerr')
        self.config_file = config_file

    def run(self):
        main(self.config_file)

def main(config_file):

    notifier = checknotif.Notifier(config_file)
    while True:
        notifier.check_notif()
        notifier.updatexml()
        time.sleep(notifier.delta_between_check)
        continue
	
	sys.exit(0)


if __name__ == '__main__':
    
    usage = "usage: %prog [options] [stop|restart]"
    parser = OptionParser(prog='notifythis', usage=usage)
    parser.add_option('', '--no-daemon', dest='no_daemon', action='store_true',
        help='Don\'t become a daemon')
    parser.add_option('-c', '', dest='config_file', action='store',
        help='Override the default configuration file from "/etc/notifythis" to CONFIG_FILE')
    parser.add_option('-d', '--debug', dest='debug_mode', action='store_true',
        help='Print the maximum debugging info (implies -vvv)')
    parser.add_option('-v', '--verbose', dest='logging_level', action='count',
        help='set error_level output to warning, info, and then debug')
    parser.set_defaults(logging_level=0, no_daemon=False, config_file=None, debug_mode=False)
    options, args = parser.parse_args()
    
    if options.debug_mode:
        options.logging_level = 3
    logging.basicConfig(level=LEVELS[options.logging_level], format='%(asctime)s %(levelname)s %(message)s')

    # try to mangle config file path (if not specified, try related to parent_module_path/etc/notifythis):
    if not options.config_file:
	config_file = parent_module_path + '/etc/notifythis'
    else:
        config_file = options.config_file

    if options.no_daemon:
        main(config_file)
    else:
        daemon = MyDaemon(config_file, '/tmp/notifythis.pid')
        
        if 'stop' in args:
            daemon.stop()
        elif 'restart' in args:
            daemon.restart()
        else:
            daemon.start()


